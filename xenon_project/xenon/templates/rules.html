<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Routing Rules</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- React & ReactDOM via CDN -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel for inline JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- react-beautiful-dnd from CDN -->
    <script src="https://unpkg.com/react-beautiful-dnd@13.1.0/dist/react-beautiful-dnd.min.js"></script>
    <style>
      body {
        background: linear-gradient(135deg, #0d1b2a, #1b263b);
        font-family: 'Inter', sans-serif;
        overflow-x: hidden;
      }
      .glass-effect {
        background: rgba(27, 38, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(167, 139, 250, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      .neon-hover {
        transition: all 0.3s ease;
      }
      .neon-hover:hover {
        box-shadow: 0 0 15px rgba(167, 139, 250, 0.7);
        transform: translateY(-2px);
      }
      @keyframes slideDownUp {
        0% { top: -50px; opacity: 0; }
        20% { top: 20px; opacity: 1; }
        80% { top: 20px; opacity: 1; }
        100% { top: -50px; opacity: 0; }
      }
      .notification {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #facc15, #fbbf24);
        color: #1e293b;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        z-index: 50;
        animation: slideDownUp 5s forwards;
        font-weight: 500;
        letter-spacing: 0.5px;
        max-width: 90%;
        text-align: center;
      }
      .menu-icon {
        width: 20px;
        height: 20px;
      }
      ::-webkit-scrollbar {
        width: 8px; /* Default for mobile */
      }
      @media (min-width: 640px) {
        ::-webkit-scrollbar {
          width: 6px; /* Thinner for desktop */
        }
      }
      ::-webkit-scrollbar-track {
        background: #1b263b;
      }
      ::-webkit-scrollbar-thumb {
        background: #a78bfa;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #c4b5fd;
      }
      #sidebarOverlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 40;
      }
      #sidebarOverlay.active {
        display: block;
      }
    </style>
  </head>
  <body class="text-gray-200 text-base">
    <div class="relative">
      <!-- Sidebar Overlay -->
      <div id="sidebarOverlay" onclick="closeSidebar()"></div>
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="fixed top-0 left-0 h-screen w-64 sm:w-72 transform -translate-x-full glass-effect transition-transform duration-300 ease-in-out z-50"
      >
        <div class="flex flex-col h-full py-4 sm:py-6">
          <div class="flex justify-between items-center mb-6 px-4 sm:px-6">
            <span class="text-xl sm:text-2xl font-semibold tracking-wide text-cyan-400">
              Xarneshin
            </span>
            <button
              id="closeSidebarButton"
              class="text-gray-300 hover:text-cyan-400 text-2xl focus:outline-none sm:hidden"
              onclick="closeSidebar()"
            >
              ×
            </button>
          </div>
          <nav class="flex-1 px-4 sm:px-6 space-y-2 sm:space-y-3">
            <a
              href="/node/{{ node_id }}/overview"
              class="block px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-gray-300 hover:text-cyan-400 neon-hover"
            >
              Overview
            </a>
            <a
              href="/node/{{ node_id }}/inbounds"
              class="block px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-gray-300 hover:text-cyan-400 neon-hover"
            >
              Inbounds
            </a>
            <a
              href="/node/{{ node_id }}/outbounds"
              class="block px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-gray-300 hover:text-cyan-400 neon-hover"
            >
              Outbounds
            </a>
            <a
              href="/node/{{ node_id }}/rules"
              class="block px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-cyan-400 bg-gray-900/50 neon-hover"
            >
              Routing Rules
            </a>
            <a
              href="/node/{{ node_id }}/dns"
              class="block px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-gray-300 hover:text-cyan-400 neon-hover"
            >
              DNS
            </a>
            <a
              href="/node/{{ node_id }}/balancers"
              class="block px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-gray-300 hover:text-cyan-400 neon-hover"
            >
              Balancer
            </a>
            <a
              href="/node/{{ node_id }}/reverse"
              class="block px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-gray-300 hover:text-cyan-400 neon-hover"
            >
              Reverse
            </a>
            <a
              href="/node/{{ node_id }}/advance"
              class="block px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-gray-300 hover:text-cyan-400 neon-hover"
            >
              Advance Settings & Editor
            </a>
            <a
              href="/nodes"
              class="block px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-gray-300 hover:text-cyan-400 neon-hover"
            >
              Back to Nodes
            </a>
            <div class="relative py-2">
              <button
                onclick="toggleSubmenu()"
                class="w-full px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-gray-300 hover:text-cyan-400 neon-hover flex justify-between items-center focus:outline-none"
              >
                <span>Support Us</span>
                <svg
                  id="submenuArrow"
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 transform transition-transform"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div
                id="submenuContent"
                class="hidden mt-2 space-y-2 pl-4 sm:pl-6 text-sm sm:text-base glass-effect rounded-lg py-2"
              >
                <a
                  href="https://t.me/XenonNet"
                  target="_blank"
                  class="flex items-center space-x-2 px-2 py-1 rounded-md text-gray-300 hover:text-cyan-400 neon-hover"
                >
                  <img
                    src="https://www.svgrepo.com/download/519656/telegram.svg"
                    class="menu-icon"
                    alt="Telegram logo"
                  />
                  <span>Join Our Channel (@XenonNet)</span>
                </a>
                <a
                  href="https://github.com/MeXenon"
                  target="_blank"
                  class="flex items-center space-x-2 px-2 py-1 rounded-md text-gray-300 hover:text-cyan-400 neon-hover"
                >
                  <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0C3.58 0 0 3.58 0 8a8 8 0 005.47 7.59c.4.07.55-.17.55-.38 0-.19-.01-.82-.016-1.49C3.97 14.91 3.4 13.81 3.4 13.81c-.36-.91-.88-1.15-.88-1.15-.72-.49.06-.48.06-.48.8.06 1.22.82 1.22.82.71 1.21 1.87.87 2.33.67.07-.775.28-1.305 .51-1.07-2.67-.303-5.47-1.33-5.47-5.93 0-1.31.468-2.382 1.235-3.222-.123-.303-.536-1.523.117-3.176 0 0 1.008-.322 3.3 1.23a11.52 11.52 0 016 0c2.29-1.553 3.296-1.23 3.296-1.23.655 1.653.242 2.873.12 3.176.77.84 1.232 1.912 1.232 3.222 0 4.609-2.803 5.624-5.47 5.92.43.372.814 1.102.814 2.222 0 1.606-.015 2.896-.015 3.286 0 .21.15.46.55.38A8 8 0 0016 8c0-4.42-3.58-8-8-8z"/>
                  </svg>
                  <span>GitHub (MeXenon)</span>
                </a>
              </div>
            </div>
          </nav>
          <div class="px-4 sm:px-6 mt-6">
            <a
              href="/logout"
              class="block w-full text-left px-3 sm:px-4 py-2 sm:py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white neon-hover"
            >
              Logout
            </a>
          </div>
        </div>
      </aside>
      <!-- Main Content -->
      <div
        id="mainContent"
        class="transform transition-all duration-300 ml-0 p-2 sm:p-4 md:p-6 lg:p-8"
      >
        <header class="flex items-center py-3 sm:py-4">
          <button
            id="hamburgerButton"
            class="p-2 text-gray-300 hover:text-cyan-400 transition focus:outline-none"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 sm:h-7 sm:w-7"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          <h1 class="text-xl sm:text-2xl md:text-3xl ml-3 sm:ml-4 font-semibold text-gray-100 tracking-wide">
            Routing Rules
          </h1>
        </header>
        <main class="mt-4 sm:mt-6">
          <div id="root" class="glass-effect p-4 sm:p-6 rounded-xl"></div>
        </main>
      </div>
    </div>
    <!-- Sidebar Script -->
    <script>
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const hamburgerButton = document.getElementById('hamburgerButton');
      const submenuContent = document.getElementById('submenuContent');
      const submenuArrow = document.getElementById('submenuArrow');
      const sidebarOverlay = document.getElementById('sidebarOverlay');

      let sidebarOpen = false;
      let submenuOpen = false;

      hamburgerButton.addEventListener('click', () => {
        toggleSidebar();
      });

      function toggleSidebar() {
        sidebarOpen = !sidebarOpen;
        if (sidebarOpen) {
          sidebar.classList.remove('-translate-x-full');
          mainContent.classList.add('sm:ml-64', 'md:ml-72');
          sidebarOverlay.classList.add('active');
        } else {
          closeSidebar();
        }
      }

      function closeSidebar() {
        sidebarOpen = false;
        sidebar.classList.add('-translate-x-full');
        mainContent.classList.remove('sm:ml-64', 'md:ml-72');
        sidebarOverlay.classList.remove('active');
      }

      function toggleSubmenu() {
        submenuOpen = !submenuOpen;
        if (submenuOpen) {
          submenuContent.classList.remove('hidden');
          submenuArrow.classList.add('rotate-180');
        } else {
          submenuContent.classList.add('hidden');
          submenuArrow.classList.remove('rotate-180');
        }
      }
    </script>

    <!-- Node ID from Flask -->
    <script>
      window.__NODE_ID__ = {{ node_id|tojson }};
    </script>

    <!-- React Code -->
    {% raw %}
    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const { DragDropContext, Droppable, Draggable } = window.ReactBeautifulDnd;

      // Helper: Filter empty fields from a rule object
      function filterEmpty(rule) {
        let filtered = {};
        Object.keys(rule).forEach((key) => {
          const value = rule[key];
          if (Array.isArray(value)) {
            if (value.length > 0) filtered[key] = value;
          } else if (typeof value === "string") {
            if (value.trim() !== "") filtered[key] = value.trim();
          } else if (value !== null && value !== undefined) {
            filtered[key] = value;
          }
        });
        return filtered;
      }

      function ChipMultiSelect({ options, selected, onChange, placeholder = "Select items" }) {
        const [isOpen, setIsOpen] = useState(false);
        const isObjectOption = options.length > 0 && typeof options[0] === "object" && options[0].value !== undefined;
        const availableOptions = isObjectOption 
          ? options.filter(opt => !selected.includes(opt.value))
          : options.filter(opt => !selected.includes(opt));
        const displaySelected = isObjectOption
          ? selected.map(val => {
              const found = options.find(o => o.value === val);
              return found ? found.label : val;
            })
          : selected;

        const toggleDropdown = () => {
          setIsOpen(prev => !prev);
        };

        const addOption = (option) => {
          const value = isObjectOption ? option.value : option;
          onChange([...selected, value]);
        };

        const removeOption = (value, e) => {
          e.stopPropagation();
          onChange(selected.filter(opt => opt !== value));
        };

        useEffect(() => {
          const handleClickOutside = (event) => {
            if (!event.target.closest(".chip-multi-select")) {
              setIsOpen(false);
            }
          };
          document.addEventListener("click", handleClickOutside);
          return () => document.removeEventListener("click", handleClickOutside);
        }, []);

        return (
          <div className="chip-multi-select relative">
            <div onClick={toggleDropdown} className="bg-gray-900/50 border border-gray-700 rounded-lg p-2 cursor-pointer flex flex-wrap gap-2">
              {displaySelected.length === 0 && <span className="text-gray-400">{placeholder}</span>}
              {selected.map((val, idx) => {
                const found = isObjectOption ? options.find(o => o.value === val) : null;
                return (
                  <div key={idx} className="bg-cyan-600 text-white px-2 py-1 rounded-lg flex items-center">
                    <span>{found ? found.label : val}</span>
                    <button type="button" onClick={(e) => removeOption(val, e)} className="ml-1 text-xs">×</button>
                  </div>
                );
              })}
            </div>
            {isOpen && availableOptions.length > 0 && (
              <div className="absolute mt-1 w-full glass-effect rounded-lg z-50">
                {availableOptions.map((option, idx) => (
                  <div 
                    key={idx} 
                    onClick={() => addOption(option)} 
                    className="p-2 border-b border-gray-700/50 last:border-b-0 hover:bg-gray-700/70 cursor-pointer text-gray-200"
                  >
                    {isObjectOption ? option.label : option}
                  </div>
                ))}
              </div>
            )}
          </div>
        );
      }

      function Modal({ title, children, onClose }) {
        return (
          <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-70 z-50 px-2 sm:px-0">
            <div className="glass-effect rounded-xl w-full max-w-full sm:max-w-3xl max-h-[90vh] overflow-y-auto">
              <div className="flex justify-between items-center p-4 sm:p-6 border-b border-gray-700/50">
                <h2 className="text-lg sm:text-2xl font-semibold text-cyan-400 tracking-wide">{title}</h2>
                <button
                  onClick={onClose}
                  className="text-gray-300 hover:text-cyan-400 text-2xl sm:text-3xl transition"
                >
                  ×
                </button>
              </div>
              <div className="p-4 sm:p-6">{children}</div>
            </div>
          </div>
        );
      }

      function ActionMenu({ coords, onClose, onEdit, onMoveUp, onMoveDown, onDelete, disabledUp, disabledDown }) {
        const menuRef = useRef(null);
        const [menuStyle, setMenuStyle] = useState({});

        useEffect(() => {
          if (menuRef.current) {
            const menuHeight = menuRef.current.offsetHeight;
            const menuWidth = menuRef.current.offsetWidth;
            const left = coords.left + coords.width;
            let top = coords.top + coords.height;
            if (top + menuHeight > window.innerHeight) {
              top = coords.top - menuHeight;
              if (top < 0) top = 0;
            }
            setMenuStyle({
              position: "fixed",
              top: top,
              left: left,
              zIndex: 1000,
              width: "8rem"
            });
          }
        }, [coords]);

        useEffect(() => {
          const handleClickOutside = (event) => {
            if (menuRef.current && !menuRef.current.contains(event.target)) {
              onClose();
            }
          };
          document.addEventListener("mousedown", handleClickOutside);
          return () => document.removeEventListener("mousedown", handleClickOutside);
        }, [onClose]);

        return ReactDOM.createPortal(
          <div ref={menuRef} style={menuStyle} className="glass-effect rounded-lg shadow-lg">
            <button onClick={(e) => { e.stopPropagation(); onEdit(); }} className="block w-full text-left px-2 py-1 hover:bg-gray-700/70 text-gray-200 neon-hover rounded-t-lg">Edit</button>
            <button onClick={(e) => { e.stopPropagation(); onMoveUp(); }} className="block w-full text-left px-2 py-1 hover:bg-gray-700/70 text-gray-200 neon-hover" disabled={disabledUp}>Move Up</button>
            <button onClick={(e) => { e.stopPropagation(); onMoveDown(); }} className="block w-full text-left px-2 py-1 hover:bg-gray-700/70 text-gray-200 neon-hover" disabled={disabledDown}>Move Down</button>
            <button onClick={(e) => { e.stopPropagation(); onDelete(); }} className="block w-full text-left px-2 py-1 hover:bg-gray-700/70 text-gray-200 neon-hover rounded-b-lg">Delete</button>
          </div>,
          document.body
        );
      }

      function QuickRuleModal({ onClose, onSave }) {
        const BLOCK_IPS_OPTIONS = [
          { value: "geoip:private", label: "Private IPs" },
          { value: "ext:geoip_IR.dat:ir", label: "Iran IPs" },
          { value: "geoip:br", label: "Brazil IPs" },
          { value: "geoip:tr", label: "Turkey IPs" },
          { value: "geoip:ua", label: "Ukraine IPs" },
          { value: "geoip:id", label: "Indonesia IPs" },
          { value: "geoip:es", label: "Spain IPs" },
          { value: "geoip:vn", label: "Vietnam IPs" },
          { value: "geoip:cn", label: "China IPs" },
          { value: "ext:geoip_RU.dat:ru", label: "Russia IPs" }
        ];
        const BLOCK_DOMAINS_OPTIONS = [
          { value: "geosite:category-ads-all", label: "Ads All" },
          { value: "ext:geosite_IR.dat:category-ads-all", label: "Iran Ads" },
          { value: "ext:geosite_RU.dat:category-ads-all", label: "Russia Ads" },
          { value: "ext:geosite_IR.dat:malware", label: "Malware" },
          { value: "ext:geosite_IR.dat:cryptominers", label: "Cryptominers" },
          { value: "ext:geosite_IR.dat:phishing", label: "Phishing" },
          { value: "regexp:.*\\.vn$", label: "Vietnam Domains" },
          { value: "regexp:.*\\.xn--p1ai$", label: "Russia Domains" },
          { value: "regexp:.*\\.su$", label: "Russia Domains" },
          { value: "regexp:.*\\.ru", label: "Russia Domains" },
          { value: "ext:geosite_RU.dat:ru-available-only-inside", label: "Russia Only" },
          { value: "regexp:.*\\.cn$", label: "China Domains" },
          { value: "geosite:cn", label: "China Sites" },
          { value: "regexp:.*\\.ir$", label: "Iran Domains" },
          { value: "ext:geosite_IR.dat:ir", label: "Iran Sites" }
        ];
        const DIRECT_IPS_OPTIONS = [
          { value: "geoip:br", label: "Brazil IPs" },
          { value: "geoip:tr", label: "Turkey IPs" },
          { value: "geoip:ua", label: "Ukraine IPs" },
          { value: "geoip:id", label: "Indonesia IPs" },
          { value: "geoip:es", label: "Spain IPs" },
          { value: "geoip:vn", label: "Vietnam IPs" },
          { value: "ext:geoip_RU.dat:ru", label: "Russia IPs" },
          { value: "geoip:cn", label: "China IPs" },
          { value: "ext:geoip_IR.dat:ir", label: "Iran IPs" },
          { value: "geoip:private", label: "Private IPs" }
        ];
        const DIRECT_DOMAINS_OPTIONS = [
          { value: "ext:geosite_IR.dat:ir", label: "Iran Sites" },
          { value: "regexp:.*\\.ir$", label: "Iran Domains" },
          { value: "regexp:.*\\.xn--mgba3a4f16a$", label: "Iran Sites" },
          { value: "geosite:cn", label: "China Sites" },
          { value: "regexp:.*\\.cn$", label: "China Domains" },
          { value: "ext:geosite_RU.dat:ru-available-only-inside", label: "Russia Only" },
          { value: "regexp:.*\\.ru$", label: "Russia Domains" },
          { value: "regexp:.*\\.su$", label: "Russia Domains" },
          { value: "regexp:.*\\.xn--p1ai$", label: "Russia Domains" },
          { value: "regexp:.*\\.vn$", label: "Vietnam Domains" }
        ];
        const IPV4_ROUTING_OPTIONS = [
          { value: "geosite:apple", label: "Apple" },
          { value: "geosite:meta", label: "Meta" },
          { value: "geosite:google", label: "Google" },
          { value: "geosite:openai", label: "OpenAI" },
          { value: "geosite:spotify", label: "Spotify" },
          { value: "geosite:netflix", label: "Netflix" },
          { value: "geosite:reddit", label: "Reddit" },
          { value: "geosite:speedtest", label: "Speedtest" }
        ];
        const IPV6_ROUTING_OPTIONS = IPV4_ROUTING_OPTIONS;
        const WARP_ROUTING_OPTIONS = IPV4_ROUTING_OPTIONS;

        const [quickRule, setQuickRule] = useState({
          blockIPs: [],
          blockDomains: [],
          directIPs: [],
          directDomains: [],
          ipv4Routing: [],
          ipv6Routing: [],
          warpRouting: []
        });

        const handleChange = (field, newVal) => {
          setQuickRule(prev => ({ ...prev, [field]: newVal }));
        };

        const handleSave = () => {
          let newRules = [];
          if (quickRule.blockIPs.length > 0) {
            newRules.push({
              type: "field",
              outboundTag: "block",
              ip: quickRule.blockIPs
            });
          }
          if (quickRule.blockDomains.length > 0) {
            newRules.push({
              type: "field",
              outboundTag: "block",
              domain: quickRule.blockDomains
            });
          }
          if (quickRule.directIPs.length > 0) {
            newRules.push({
              type: "field",
              outboundTag: "direct",
              ip: quickRule.directIPs
            });
          }
          if (quickRule.directDomains.length > 0) {
            newRules.push({
              type: "field",
              outboundTag: "direct",
              domain: quickRule.directDomains
            });
          }
          if (quickRule.ipv4Routing.length > 0) {
            newRules.push({
              type: "field",
              outboundTag: "IPv4",
              domain: quickRule.ipv4Routing
            });
          }
          if (quickRule.ipv6Routing.length > 0) {
            newRules.push({
              type: "field",
              outboundTag: "IPv6",
              domain: quickRule.ipv6Routing
            });
          }
          if (quickRule.warpRouting.length > 0) {
            newRules.push({
              type: "field",
              outboundTag: "warp",
              domain: quickRule.warpRouting
            });
          }
          onSave(newRules);
          onClose();
        };

        return (
          <Modal title="Add Quick Rule" onClose={onClose}>
            <div className="space-y-4">
              <div>
                <h3 className="text-lg font-semibold text-cyan-400">Block Rule</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block mb-1 text-gray-300">Block IPs</label>
                    <ChipMultiSelect 
                      options={BLOCK_IPS_OPTIONS}
                      selected={quickRule.blockIPs}
                      onChange={(newVal) => handleChange("blockIPs", newVal)}
                      placeholder="Select IPs"
                    />
                  </div>
                  <div>
                    <label className="block mb-1 text-gray-300">Block Domains</label>
                    <ChipMultiSelect 
                      options={BLOCK_DOMAINS_OPTIONS}
                      selected={quickRule.blockDomains}
                      onChange={(newVal) => handleChange("blockDomains", newVal)}
                      placeholder="Select Domains"
                    />
                  </div>
                </div>
              </div>
              <div>
                <h3 className="text-lg font-semibold text-cyan-400">Direct Rule</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block mb-1 text-gray-300">Direct IPs</label>
                    <ChipMultiSelect 
                      options={DIRECT_IPS_OPTIONS}
                      selected={quickRule.directIPs}
                      onChange={(newVal) => handleChange("directIPs", newVal)}
                      placeholder="Select IPs"
                    />
                  </div>
                  <div>
                    <label className="block mb-1 text-gray-300">Direct Domains</label>
                    <ChipMultiSelect 
                      options={DIRECT_DOMAINS_OPTIONS}
                      selected={quickRule.directDomains}
                      onChange={(newVal) => handleChange("directDomains", newVal)}
                      placeholder="Select Domains"
                    />
                  </div>
                </div>
              </div>
              <div>
                <h3 className="text-lg font-semibold text-cyan-400">Routing</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block mb-1 text-gray-300">IPv4 Routing</label>
                    <ChipMultiSelect 
                      options={IPV4_ROUTING_OPTIONS}
                      selected={quickRule.ipv4Routing}
                      onChange={(newVal) => handleChange("ipv4Routing", newVal)}
                      placeholder="Select Options"
                    />
                  </div>
                  <div>
                    <label className="block mb-1 text-gray-300">IPv6 Routing</label>
                    <ChipMultiSelect 
                      options={IPV6_ROUTING_OPTIONS}
                      selected={quickRule.ipv6Routing}
                      onChange={(newVal) => handleChange("ipv6Routing", newVal)}
                      placeholder="Select Options"
                    />
                  </div>
                </div>
              </div>
              <div>
                <h3 className="text-lg font-semibold text-cyan-400">Warp Routing</h3>
                <ChipMultiSelect 
                  options={WARP_ROUTING_OPTIONS}
                  selected={quickRule.warpRouting}
                  onChange={(newVal) => handleChange("warpRouting", newVal)}
                  placeholder="Select Options"
                />
              </div>
            </div>
            <div className="flex justify-end space-x-4 mt-6">
              <button onClick={onClose} className="bg-gray-700 hover:bg-gray-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg text-sm sm:text-base neon-hover">
                Cancel
              </button>
              <button onClick={handleSave} className="bg-cyan-600 hover:bg-cyan-700 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg text-sm sm:text-base neon-hover">
                Save Quick Rule
              </button>
            </div>
          </Modal>
        );
      }

      function RoutingRulesPage({ nodeId }) {
        const [rules, setRules] = useState([]);
        const [modalOpen, setModalOpen] = useState(false);
        const [quickModalOpen, setQuickModalOpen] = useState(false);
        const [editingIndex, setEditingIndex] = useState(null);
        const [editingRule, setEditingRule] = useState({
          domainMatcher: '',
          source: '',
          sourcePort: '',
          network: '',
          protocol: [],
          ip: '',
          domain: '',
          user: '',
          port: '',
          inboundTag: [],
          outboundTag: '',
          balancerTag: '',
          attrs: [],
          destinationIP: '',
          destinationPort: ''
        });
        const [actionMenuIndex, setActionMenuIndex] = useState(null);
        const [actionMenuCoords, setActionMenuCoords] = useState(null);
        const [isSavingAll, setIsSavingAll] = useState(false);

        const [inboundTagOptions, setInboundTagOptions] = useState([]);
        const [outboundTagOptions, setOutboundTagOptions] = useState([]);
        const [balancerTagOptions, setBalancerTagOptions] = useState([]);
        const protocolOptions = ['http', 'tls', 'bittorrent'];

        useEffect(() => {
          fetch(`/node/${nodeId}/rules_data`)
            .then((res) => res.json())
            .then((data) => {
              setRules(data.rules || []);
            })
            .catch((err) => console.error('Error fetching rules:', err));

          fetch(`/node/${nodeId}/tags`)
            .then((res) => res.json())
            .then((data) => {
              setInboundTagOptions(data.inbound_tags || []);
              setOutboundTagOptions(data.outbound_tags || []);
              setBalancerTagOptions(data.balancer_tags || []);
            })
            .catch((err) => console.error('Error fetching tags:', err));
        }, [nodeId]);

        const onDragEnd = (result) => {
          if (!result.destination) return;
          const newRules = Array.from(rules);
          const [removed] = newRules.splice(result.source.index, 1);
          newRules.splice(result.destination.index, 0, removed);
          setRules(newRules);
        };

        const handleActionMenuClick = (e, index) => {
          e.stopPropagation();
          const rect = e.currentTarget.getBoundingClientRect();
          setActionMenuCoords({
            left: rect.left,
            top: rect.top,
            width: rect.width,
            height: rect.height
          });
          setActionMenuIndex(index);
        };

        const openModal = (rule = null, index = null) => {
          if (rule) {
            setEditingRule({
              ...rule,
              protocol: rule.protocol || [],
              inboundTag: rule.inboundTag || [],
              attrs: rule.attrs || []
            });
            setEditingIndex(index);
          } else {
            setEditingRule({
              domainMatcher: '',
              source: '',
              sourcePort: '',
              network: '',
              protocol: [],
              ip: '',
              domain: '',
              user: '',
              port: '',
              inboundTag: [],
              outboundTag: '',
              balancerTag: '',
              attrs: [],
              destinationIP: '',
              destinationPort: ''
            });
            setEditingIndex(null);
          }
          setModalOpen(true);
          setActionMenuIndex(null);
        };

        const closeModal = () => {
          setModalOpen(false);
        };

        const handleInputChange = (e) => {
          const { name, value } = e.target;
          setEditingRule((prev) => ({ ...prev, [name]: value }));
        };

        const handleAttrChange = (index, keyOrValue, newValue) => {
          const newAttrs = [...editingRule.attrs];
          if (keyOrValue === 'key') {
            newAttrs[index][0] = newValue;
          } else {
            newAttrs[index][1] = newValue;
          }
          setEditingRule((prev) => ({ ...prev, attrs: newAttrs }));
        };

        const addAttribute = () => {
          setEditingRule((prev) => ({ ...prev, attrs: [...prev.attrs, ['', '']] }));
        };

        const removeAttribute = (index) => {
          setEditingRule((prev) => ({
            ...prev,
            attrs: prev.attrs.filter((_, i) => i !== index)
          }));
        };

        const saveRule = () => {
          const filteredRule = filterEmpty(editingRule);
          const newRules = [...rules];
          if (editingIndex !== null) {
            newRules[editingIndex] = filteredRule;
          } else {
            newRules.push(filteredRule);
          }
          setRules(newRules);
          closeModal();
        };

        const deleteRule = (index) => {
          if (confirm('Are you sure you want to delete this rule?')) {
            setRules(rules.filter((_, i) => i !== index));
            setActionMenuIndex(null);
          }
        };

        const moveUp = (index) => {
          if (index <= 0) return;
          const newRules = [...rules];
          [newRules[index - 1], newRules[index]] = [newRules[index], newRules[index - 1]];
          setRules(newRules);
          setActionMenuIndex(null);
        };

        const moveDown = (index) => {
          if (index >= rules.length - 1) return;
          const newRules = [...rules];
          [newRules[index], newRules[index + 1]] = [newRules[index + 1], newRules[index]];
          setRules(newRules);
          setActionMenuIndex(null);
        };

        const saveAllRules = () => {
          setIsSavingAll(true);
          const filteredRules = rules.map(rule => filterEmpty(rule));
          fetch(`/node/${nodeId}/save_rules`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rules: filteredRules })
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                const notif = document.createElement("div");
                notif.className = "notification";
                notif.textContent = "Rules saved successfully!";
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 5000);
              } else {
                alert('Error saving rules: ' + (data.error || data.message));
              }
            })
            .catch((err) => {
              console.error('Error saving rules:', err);
              alert('Error saving rules.');
            })
            .finally(() => setIsSavingAll(false));
        };

        const handleQuickRuleSave = (newQuickRules) => {
          setRules(prev => [...prev, ...newQuickRules]);
        };

        return (
          <div>
            <div className="p-4 sm:p-6">
              <h4 className="text-xl sm:text-2xl md:text-3xl font-semibold mb-4 sm:mb-6 text-cyan-400 tracking-wide">
                Node ID: {nodeId} - Routing Rules
              </h4>
              <p className="mb-4 sm:mb-6 text-gray-300">Existing rules are loaded from the main configuration.</p>
              <div className="flex flex-col sm:flex-row items-start sm:items-center mb-6 sm:mb-8 space-y-3 sm:space-y-0 sm:space-x-4">
                <button onClick={() => openModal()} className="w-full sm:w-auto bg-cyan-600 hover:bg-cyan-700 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg text-sm sm:text-base neon-hover">
                  Add Rule
                </button>
                <button onClick={() => setQuickModalOpen(true)} className="w-full sm:w-auto bg-orange-500 hover:bg-orange-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg text-sm sm:text-base neon-hover">
                  Add Quick Rule
                </button>
                <button onClick={saveAllRules} disabled={isSavingAll} className={`w-full sm:w-auto ml-0 sm:ml-auto bg-cyan-600 hover:bg-cyan-700 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg text-sm sm:text-base neon-hover ${isSavingAll ? "opacity-70 cursor-not-allowed" : ""}`}>
                  {isSavingAll ? "Saving..." : "Save All Rules"}
                </button>
              </div>
              <div className="relative overflow-x-auto overflow-y-visible rounded-lg">
                <DragDropContext onDragEnd={onDragEnd}>
                  <table className="min-w-full text-left glass-effect shadow-xl">
                    <thead className="text-sm sm:text-base font-medium uppercase bg-gradient-to-r from-indigo-900 via-purple-900 to-cyan-900 text-gray-100">
                      <tr>
                        <th rowSpan="2" className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">No.</th>
                        <th colSpan="7" className="py-3 px-3 sm:px-6 border-b border-gray-700">Traffic Rules</th>
                        <th colSpan="3" className="py-3 px-3 sm:px-6 border-b border-gray-700">Destination Rules</th>
                        <th colSpan="2" className="py-3 px-3 sm:px-6 border-b border-gray-700">Inbound Rules</th>
                        <th rowSpan="2" className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">Outbound</th>
                        <th rowSpan="2" className="py-3 px-3 sm:px-6 border-b border-gray-700">Balancing</th>
                      </tr>
                      <tr className="bg-gradient-to-r from-indigo-900 via-purple-900 to-cyan-900">
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">Source</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">Network</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">IP</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">Port</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">L4</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">Protocol</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">Attrs</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">IP</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">Domain</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">Port</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">Inbound Tag</th>
                        <th className="py-3 px-3 sm:px-6 border-b border-gray-700 border-r border-gray-300/30">User</th>
                      </tr>
                    </thead>
                    <Droppable droppableId="tableBody">
                      {(provided) => (
                        <tbody ref={provided.innerRef} {...provided.droppableProps}>
                          {rules.map((rule, index) => (
                            <Draggable key={`rule-${index}`} draggableId={`rule-${index}`} index={index}>
                              {(provided) => (
                                <tr ref={provided.innerRef} {...provided.draggableProps} className="bg-gray-800/50 border-b border-gray-700/50 hover:bg-gray-700/70 transition">
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50 text-center relative">
                                    <span {...provided.dragHandleProps} className="inline-block mr-2 cursor-move text-gray-300">☰</span>
                                    <span onClick={(e) => { e.stopPropagation(); handleActionMenuClick(e, index); }} className="inline-block cursor-pointer text-white">⋮</span>
                                  </td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.source || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.network || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.trafficIP || rule.ip || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.trafficPort || rule.port || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.l4 || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{Array.isArray(rule.protocol) ? rule.protocol.join(", ") : rule.protocol || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{(rule.attrs || []).map(a => a.join(":")).join(", ")}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.destinationIP || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.domain || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.destinationPort || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{Array.isArray(rule.inboundTag) ? rule.inboundTag.join(", ") : rule.inboundTag || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.user || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.outboundTag || ""}</td>
                                  <td className="py-2 px-3 sm:px-6 border-b border-gray-700/50">{rule.balancerTag || ""}</td>
                                </tr>
                              )}
                            </Draggable>
                          ))}
                          {provided.placeholder}
                        </tbody>
                      )}
                    </Droppable>
                  </table>
                </DragDropContext>
                {actionMenuCoords && actionMenuIndex !== null && (
                  <ActionMenu 
                    coords={actionMenuCoords}
                    onClose={() => setActionMenuCoords(null)}
                    onEdit={() => openModal(rules[actionMenuIndex], actionMenuIndex)}
                    onMoveUp={() => moveUp(actionMenuIndex)}
                    onMoveDown={() => moveDown(actionMenuIndex)}
                    onDelete={() => deleteRule(actionMenuIndex)}
                    disabledUp={actionMenuIndex === 0}
                    disabledDown={actionMenuIndex === rules.length - 1}
                  />
                )}
              </div>
            </div>

            {modalOpen && (
              <Modal title={editingIndex !== null ? 'Edit Rule' : 'Add Rule'} onClose={closeModal}>
                <form className="space-y-4">
                  <div>
                    <label className="block mb-1 text-gray-300">Domain Matcher</label>
                    <select name="domainMatcher" value={editingRule.domainMatcher} onChange={handleInputChange} className="w-full p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                      <option value=""></option>
                      <option value="hybrid">hybrid</option>
                      <option value="linear">linear</option>
                    </select>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block mb-1 text-gray-300">Source IPs</label>
                      <input type="text" name="source" value={editingRule.source} onChange={handleInputChange} placeholder="e.g., 192.168.1.1,10.0.0.1" className="w-full p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                    </div>
                    <div>
                      <label className="block mb-1 text-gray-300">Source Port</label>
                      <input type="text" name="sourcePort" value={editingRule.sourcePort} onChange={handleInputChange} placeholder="e.g., 80,443" className="w-full p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                    </div>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block mb-1 text-gray-300">Network</label>
                      <select name="network" value={editingRule.network} onChange={handleInputChange} className="w-full p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value=""></option>
                        <option value="TCP">TCP</option>
                        <option value="UDP">UDP</option>
                        <option value="TCP,UDP">TCP,UDP</option>
                      </select>
                    </div>
                    <div>
                      <label className="block mb-1 text-gray-300">Protocols</label>
                      <ChipMultiSelect options={protocolOptions} selected={editingRule.protocol} onChange={(newVal) => setEditingRule(prev => ({ ...prev, protocol: newVal }))} placeholder="Select protocols" />
                    </div>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block mb-1 text-gray-300">IP</label>
                      <input type="text" name="ip" value={editingRule.ip} onChange={handleInputChange} placeholder="e.g., 8.8.8.8" className="w-full p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                    </div>
                    <div>
                      <label className="block mb-1 text-gray-300">Domain</label>
                      <input type="text" name="domain" value={editingRule.domain} onChange={handleInputChange} placeholder="e.g., example.com" className="w-full p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                    </div>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block mb-1 text-gray-300">User</label>
                      <input type="text" name="user" value={editingRule.user} onChange={handleInputChange} className="w-full p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                    </div>
                    <div>
                      <label className="block mb-1 text-gray-300">Port</label>
                      <input type="text" name="port" value={editingRule.port} onChange={handleInputChange} className="w-full p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                    </div>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block mb-1 text-gray-300">Inbound Tags</label>
                      <ChipMultiSelect options={inboundTagOptions} selected={editingRule.inboundTag} onChange={(newVal) => setEditingRule(prev => ({ ...prev, inboundTag: newVal }))} placeholder="Select inbound tags" />
                    </div>
                    <div>
                      <label className="block mb-1 text-gray-300">Outbound Tag</label>
                      <select name="outboundTag" value={editingRule.outboundTag} onChange={handleInputChange} className="w-full p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value=""></option>
                        {outboundTagOptions.map((tag) => (
                          <option key={tag} value={tag}>{tag}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                  <div>
                    <label className="block mb-1 text-gray-300">Balancer Tag</label>
                    <select name="balancerTag" value={editingRule.balancerTag} onChange={handleInputChange} className="w-full p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                      <option value=""></option>
                      {balancerTagOptions.map((tag) => (
                        <option key={tag} value={tag}>{tag}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block mb-1 text-gray-300">Attributes</label>
                    <div id="attributesList">
                      {(editingRule.attrs || []).map((attr, index) => (
                        <div key={index} className="flex space-x-2 mb-2">
                          <input type="text" value={attr[0]} onChange={(e) => handleAttrChange(index, 'key', e.target.value)} placeholder="Key" className="w-1/2 p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                          <input type="text" value={attr[1]} onChange={(e) => handleAttrChange(index, 'value', e.target.value)} placeholder="Value" className="w-1/2 p-2 bg-gray-900/50 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                          <button type="button" onClick={() => removeAttribute(index)} className="bg-red-600 hover:bg-red-700 text-white px-2 rounded-lg neon-hover">×</button>
                        </div>
                      ))}
                      <button type="button" onClick={addAttribute} className="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded-lg text-sm neon-hover">Add Attribute</button>
                    </div>
                  </div>
                </form>
                <div className="flex justify-end space-x-4 mt-6">
                  <button onClick={closeModal} className="bg-gray-700 hover:bg-gray-600 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg text-sm sm:text-base neon-hover">
                    Cancel
                  </button>
                  <button onClick={saveRule} className="bg-cyan-600 hover:bg-cyan-700 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg text-sm sm:text-base neon-hover">
                    Save Rule
                  </button>
                </div>
              </Modal>
            )}
            {quickModalOpen && (
              <QuickRuleModal onClose={() => setQuickModalOpen(false)} onSave={handleQuickRuleSave} />
            )}
          </div>
        );
      }

      ReactDOM.render(
        <RoutingRulesPage nodeId={window.__NODE_ID__} />,
        document.getElementById('root')
      );
    </script>
    {% endraw %}
  </body>
</html>