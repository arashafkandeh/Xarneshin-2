<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xarzneshin Core Manager - Nodes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        background: linear-gradient(135deg, #0d1b2a, #1b263b);
        font-family: 'Inter', sans-serif;
        overflow-x: hidden;
      }
      .glass-effect {
        background: rgba(27, 38, 59, 0.7);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(167, 139, 250, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
      }
      .neon-hover {
        transition: box-shadow 0.3s ease, background-color 0.3s ease;
      }
      .neon-hover:hover {
        box-shadow: 0 0 15px rgba(167, 139, 250, 0.7);
      }
      @keyframes slideDownUp {
        0% { top: -50px; opacity: 0; }
        20% { top: 20px; opacity: 1; }
        80% { top: 20px; opacity: 1; }
        100% { top: -50px; opacity: 0; }
      }
      .notification {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(45deg, #facc15, #fbbf24);
        color: #1e293b;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        z-index: 50;
        animation: slideDownUp 5s forwards;
        font-weight: 500;
        letter-spacing: 0.5px;
        max-width: 90%;
        text-align: center;
      }
      ::-webkit-scrollbar {
        width: 8px;
      }
      @media (min-width: 640px) {
        ::-webkit-scrollbar {
          width: 6px;
        }
        .table-wrapper {
          max-height: calc(100vh - 200px);
          overflow-y: auto;
          overflow-x: auto;
        }
      }
      ::-webkit-scrollbar-track {
        background: #1b263b;
      }
      ::-webkit-scrollbar-thumb {
        background: #a78bfa;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #c4b5fd;
      }
      input[type="radio"] {
        appearance: none;
        width: 16px;
        height: 16px;
        border: 2px solid #a78bfa;
        border-radius: 50%;
        background-color: transparent;
        cursor: pointer;
      }
      input[type="radio"]:checked {
        background-color: #3b82f6;
        border-color: #3b82f6;
        box-shadow: inset 0 0 0 3px rgba(27, 38, 59, 0.7);
      }
    </style>
  </head>
  <body class="text-gray-100">
    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-900 to-cyan-900 shadow-md">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex flex-col sm:flex-row items-center justify-between">
        <div class="flex flex-col text-center sm:text-left">
          <span class="text-white text-xl sm:text-2xl font-bold text-cyan-400">Xarzneshin Core Manager</span>
          <span class="text-gray-300 text-xs sm:text-sm">Xenon Marzneshin Core Manager</span>
        </div>
        <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 mt-3 sm:mt-0">
          <div class="relative">
            <button id="supportToggle" class="inline-flex items-center justify-center bg-green-600 hover:bg-green-700 text-white text-sm sm:text-base font-semibold px-3 sm:px-4 py-2 rounded-lg transition-colors neon-hover">
              Support Us
            </button>
            <div id="supportDropdown" class="absolute right-0 mt-2 w-56 glass-effect rounded-lg shadow-lg hidden z-50">
              <div class="py-2">
                <a href="https://t.me/xenonNet" target="_blank" class="flex items-center px-4 py-2 text-sm text-gray-200 hover:bg-gray-700/70 neon-hover">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-8 sm:w-8 mr-2" viewBox="0 0 255.99908 255.99908">
                    <g fill="#a5b4fc" fill-rule="nonzero">
                      <g transform="scale(5.12,5.12)">
                        <path d="M25,2c-12.69071,0 -23,10.3093 -23,23c0,12.6907 10.30929,23 23,23c12.69071,0 23,-10.3093 23,-23c0,-12.6907 -10.30929,-23 -23,-23zM25,4c11.60983,0 21,9.39017 21,21c0,11.60983 -9.39017,21 -21,21c-11.60983,0 -21,-9.39017 -21,-21c0,-11.60982 9.39017,-21 21,-21zM34.08789,14.03516c-0.684,0 -1.45256,0.15842 -2.35156,0.48242c-1.396,0.503 -17.81559,7.47458 -19.68359,8.26758c-1.068,0.454 -3.05664,1.2985 -3.05664,3.3125c0,1.335 0.78227,2.28984 2.32227,2.83984c0.828,0.295 2.79455,0.89108 3.93555,1.20508c0.484,0.133 0.99834,0.20117 1.52734,0.20117c1.035,0 2.07658,-0.25789 2.89258,-0.71289c-0.007,0.168 -0.00242,0.33781 0.01758,0.50781c0.123,1.05 0.77047,2.03758 1.73047,2.64258c0.628,0.396 5.75744,3.83291 6.52344,4.37891c1.076,0.769 2.2655,1.17578 3.4375,1.17578c2.24,0 2.99152,-2.31283 3.35352,-3.42383c0.525,-1.613 2.49089,-14.72997 2.71289,-17.04297c0.151,-1.585 -0.50958,-2.89019 -1.76758,-3.49219c-0.471,-0.227 -1.00875,-0.3418 -1.59375,-0.3418zM34.08789,16.03516c0.275,0 0.52052,0.04548 0.72852,0.14648c0.473,0.227 0.71363,0.73305 0.64063,1.49805c-0.242,2.523 -2.20309,15.32928 -2.62109,16.61328c-0.358,1.098 -0.73512,2.04297 -1.45313,2.04297c-0.718,0 -1.50239,-0.25169 -2.27539,-0.80469c-0.773,-0.552 -5.90614,-3.99436 -6.61914,-4.44336c-0.625,-0.394 -1.28647,-1.37617 -0.35547,-2.32617c0.767,-0.782 6.58503,-6.42878 7.08203,-6.92578c0.37,-0.371 0.19698,-0.81836 -0.16602,-0.81836c-0.125,0 -0.27469,0.05269 -0.42969,0.17969c-0.608,0.497 -9.08436,6.169 -9.81836,6.625c-0.486,0.302 -1.23853,0.51953 -2.01953,0.51953c-0.333,0 -0.67014,-0.03991 -0.99414,-0.12891c-1.128,-0.311 -3.03692,-0.89016 -3.79492,-1.16016c-0.729,-0.26 -0.99414,-0.50908 -0.99414,-0.95508c0,-0.634 0.89489,-1.07166 1.83789,-1.47266c0.996,-0.423 18.23012,-7.74156 19.57812,-8.22656c0.624,-0.226 1.19483,-0.36328 1.67383,-0.36328z"></path>
                      </g>
                    </g>
                  </svg>
                  Join Telegram
                </a>
                <a href="https://github.com/MeXenon" target="_blank" class="flex items-center px-4 py-2 text-sm text-gray-200 hover:bg-gray-700/70 neon-hover">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 sm:h-8 sm:w-8 mr-2" fill="#a5b4fc" viewBox="0 0 24 24">
                    <path d="M12 0C5.371 0 0 5.373 0 12a12 12 0 008.205 11.386c.6.111.82-.261.82-.58 0-.287-.011-1.244-.016-2.253-3.338.724-4.042-1.61-4.042-1.61-.546-1.386-1.333-1.754-1.333-1.754-1.089-.745.083-.73.083-.73 1.205.085 1.84 1.238 1.84 1.238 1.07 1.833 2.809 1.304 3.495.997.107-.775.418-1.305.762-1.605-2.665-.305-5.466-1.333-5.466-5.93 0-1.31.469-2.382 1.236-3.221-.124-.304-.536-1.524.117-3.176 0 0 1.008-.322 3.301 1.23a11.52 11.52 0 016.003 0c2.292-1.553 3.298-1.23 3.298-1.23.654 1.653.242 2.873.119 3.176.77.839 1.235 1.911 1.235 3.221 0 4.61-2.804 5.622-5.475 5.921.43.37.814 1.103.814 2.222 0 1.606-.015 2.898-.015 3.293 0 .322.218.697.825.579A12.005 12.005 0 0024 12c0-6.627-5.373-12-12-12z"/>
                  </svg>
                  GitHub
                </a>
              </div>
            </div>
            <a href="/logout" class="inline-flex items-center justify-center bg-red-600 hover:bg-red-700 text-white text-sm sm:text-base font-semibold px-3 sm:px-4 py-2 rounded-lg transition-colors neon-hover">
              Logout
            </a>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="max-w-7xl mx-auto my-6 sm:my-8 px-4 sm:px-6">
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            <div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-yellow-500/20 border border-yellow-400/50 rounded-lg text-yellow-300 text-sm">
              {% for msg in messages %}
                <div>{{ msg }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
        <div class="flex justify-between items-center mb-4 sm:mb-6">
          <h2 class="text-xl sm:text-2xl md:text-3xl font-bold text-cyan-400">All Nodes</h2>
          <div class="flex space-x-2">
            <button onclick="openAddNodeModal()"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm transition-colors neon-hover">
              Add Node
            </button>
            <button id="restartAllNodesCoresBtn" onclick="showRestartAllConfirm()"
                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm transition-colors neon-hover">
              Restart All Xray Cores
            </button>
          </div>
        </div>

        <!-- Desktop Table View -->
        <div class="hidden sm:block overflow-x-auto">
          <div class="table-wrapper relative glass-effect rounded-lg shadow-xl">
            <table class="min-w-[900px] w-full table-auto text-sm">
              <thead class="sticky top-0 z-10 bg-gradient-to-r from-indigo-900 via-purple-900 to-cyan-900 text-gray-100">
                <tr>
                  <th class="px-4 sm:px-6 py-3 sm:py-4 text-left">Node</th>
                  <th class="px-4 sm:px-6 py-3 sm:py-4 text-left">Status</th>
                  <th class="px-4 sm:px-6 py-3 sm:py-4 text-left">Core / Version</th>
                  <th class="px-4 sm:px-6 py-3 sm:py-4 text-left">Xray Actions</th>
                  <th class="px-4 sm:px-6 py-3 sm:py-4 text-left">Core Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-700/50">
                {% for item in nodes["items"] %}
                  {% set xray_running = item["backends"]|selectattr("name", "equalto", "xray")|selectattr("running", "equalto", true)|list|length > 0 %}
                  {% for backend in item["backends"] %}
                    <tr class="hover:bg-gray-700/70 transition-colors">
                      <td class="px-4 sm:px-6 py-3 sm:py-4 font-medium">
                        {{ item["id"] }} - {{ item["name"] }}
                      </td>
                      <td class="px-4 sm:px-6 py-3 sm:py-4 font-medium">
                        {% if item["status"] == "healthy" %}
                          <span class="bg-green-600/80 text-white px-2 py-1 rounded-full text-xs">Healthy</span>
                        {% else %}
                          <span class="bg-red-600/80 text-white px-2 py-1 rounded-full text-xs">{{ item["status"] }}</span>
                        {% endif %}
                      </td>
                      <td class="px-4 sm:px-6 py-3 sm:py-4">
                        <div>
                          <span class="block text-gray-200">{{ backend["name"] }}</span>
                          <span class="block text-xs text-gray-400 mt-1">
                            Version: {{ backend["version"] or '---' }} | Running:
                            {% if backend["running"] %}
                              <span class="text-green-400">True</span>
                            {% else %}
                              <span class="text-red-400">False</span>
                            {% endif %}
                          </span>
                        </div>
                      </td>
                      <td class="px-4 sm:px-6 py-3 sm:py-4">
                        {% if backend["name"] == "xray" and backend["running"] %}
                          <a href="{{ url_for('overview', node_id=item['id']) }}"
                             class="block bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded text-xs transition-colors neon-hover w-32 text-center">
                            Manage Xray
                          </a>
                        {% endif %}
                      </td>
                      <td class="px-4 sm:px-6 py-3 sm:py-4">
                        {% if loop.first and item["name"] == "local" %}
                          <button id="changeCoreBtn-{{ item['id'] }}"
                                  onclick="openChangeCoreModal({{ item['id'] }})"
                                  class="block bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded text-xs transition-colors neon-hover w-32">
                            Change Xray Core
                          </button>
                        {% endif %}
                        {% if backend["name"] == "xray" %}
                          <button onclick="showRestartConfirm({{ item['id'] }})"
                                  class="block {% if loop.first and item['name'] == 'local' %}mt-1.5{% endif %} bg-blue-400 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-xs transition-colors neon-hover w-32">
                            Restart Xray
                          </button>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Mobile Card View -->
        <div class="block sm:hidden space-y-4">
          {% for item in nodes["items"] %}
            <div class="glass-effect rounded-lg shadow-xl p-4">
              <div class="mb-2">
                <span class="font-bold text-gray-200">{{ item["id"] }} - {{ item["name"] }}</span>
                {% if item["status"] == "healthy" %}
                  <span class="bg-green-600/80 text-white px-2 py-1 rounded-full text-xs ml-2">Healthy</span>
                {% else %}
                  <span class="bg-red-600/80 text-white px-2 py-1 rounded-full text-xs ml-2">{{ item["status"] }}</span>
                {% endif %}
              </div>
              <div class="space-y-2">
                {% for backend in item["backends"] %}
                  <div class="border-t border-gray-700/50 pt-2 flex flex-col space-y-2">
                    <div>
                      <span class="block font-medium text-gray-200">{{ backend["name"] }}</span>
                      <span class="block text-xs text-gray-400">
                        Version: {{ backend["version"] or '---' }} | Running:
                        {% if backend["running"] %}
                          <span class="text-green-400">True</span>
                        {% else %}
                          <span class="text-red-400">False</span>
                        {% endif %}
                      </span>
                    </div>
                  </div>
                {% endfor %}
              </div>
              <div class="mt-2 flex flex-col gap-1.5">
                {% if item["backends"]|selectattr("name", "equalto", "xray")|selectattr("running", "equalto", true)|list|length > 0 %}
                  <a href="{{ url_for('overview', node_id=item['id']) }}"
                     class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded text-sm transition-colors neon-hover w-full text-center">
                    Manage Xray
                  </a>
                {% endif %}
                {% if item["name"] == "local" %}
                  <button id="changeCoreBtn-{{ item['id'] }}"
                          onclick="openChangeCoreModal({{ item['id'] }})"
                          class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded text-sm transition-colors neon-hover w-full">
                    Change Xray Core
                  </button>
                {% endif %}
                {% if item["backends"]|selectattr("name", "equalto", "xray")|list|length > 0 %}
                  <button onclick="showRestartConfirm({{ item['id'] }})"
                          class="bg-blue-400 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-sm transition-colors neon-hover w-full">
                    Restart Xray
                  </button>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Modal for Changing Core -->
        <div id="changeCoreModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
          <div class="glass-effect rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-cyan-400 mb-4">Change Xray Core</h3>
            <div id="versionList" class="mb-4 max-h-64 overflow-y-auto">
              <!-- Versions will be populated dynamically -->
            </div>
            <div id="customVersionInput" class="mb-4 hidden">
              <input type="text" id="customVersionField" class="w-full p-2 bg-gray-800 text-gray-200 rounded border border-gray-700 focus:outline-none focus:border-purple-500" placeholder="e.g., v1.8.23">
              <p class="text-xs text-gray-400 mt-1">Enter a valid Xray version like v1.8.23</p>
            </div>
            <div class="flex justify-between items-center">
              <div>
                <button id="customVersionBtn" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded neon-hover hidden">Custom Version</button>
                <button id="backToListBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded neon-hover hidden">Back</button>
              </div>
              <div class="flex space-x-2">
                <button onclick="closeChangeCoreModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded neon-hover">Cancel</button>
                <button id="selectVersionBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded neon-hover" disabled>Select</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Confirmation Modal for Core Change -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
          <div class="glass-effect rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-cyan-400 mb-4">Confirm Core Change</h3>
            <p class="text-gray-200 mb-4">Are you sure you want to change the Xray core to <span id="selectedVersion"></span>?</p>
            <div class="flex justify-end space-x-2">
              <button onclick="closeConfirmModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded neon-hover">No</button>
              <button onclick="startCoreChange()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded neon-hover">Yes</button>
            </div>
          </div>
        </div>

        <!-- Restart Confirmation Modal -->
        <div id="restartConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
          <div class="glass-effect rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-cyan-400 mb-4" id="restartConfirmTitle">Confirm Restart</h3>
            <p class="text-gray-200 mb-4" id="restartConfirmMessage"></p>
            <div class="flex justify-end space-x-2">
              <button onclick="closeRestartConfirm()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded neon-hover">No</button>
              <button id="confirmRestartBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded neon-hover">Yes</button>
            </div>
          </div>
        </div>

        <!-- Add Node Modal -->
        <div id="addNodeModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center px-4">
          <div class="glass-effect rounded-lg p-6 sm:p-8 w-full max-w-lg shadow-xl transform transition-all sm:my-8 opacity-0 translate-y-10 overflow-y-auto max-h-[85vh]"
               role="dialog" aria-modal="true" aria-labelledby="addNodeModalTitle">
            <div class="flex justify-between items-center mb-6">
              <h3 id="addNodeModalTitle" class="text-xl sm:text-2xl font-bold text-cyan-400">Add New Node via SSH</h3>
              <button type="button" onclick="closeAddNodeModal()"
                      class="text-gray-400 hover:text-gray-200 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
              </button>
            </div>
            <form id="addNodeForm">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div>
                  <label for="nodeName" class="block text-sm font-medium text-gray-300 mb-1">Node Name</label>
                  <input type="text" id="nodeName" name="nodeName" required
                         class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                         placeholder="e.g., My Awesome Server">
                </div>
                <div>
                  <label for="serverIP" class="block text-sm font-medium text-gray-300 mb-1">Server IP Address</label>
                  <input type="text" id="serverIP" name="serverIP" required
                         class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                         placeholder="e.g., 192.168.1.100">
                </div>
                <div>
                  <label for="sshUser" class="block text-sm font-medium text-gray-300 mb-1">SSH Username</label>
                  <input type="text" id="sshUser" name="sshUser" value="root" required
                         class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                         placeholder="e.g., root or admin">
                </div>
                <div>
                  <label for="sshPassword" class="block text-sm font-medium text-gray-300 mb-1">SSH Password</label>
                  <input type="password" id="sshPassword" name="sshPassword" required
                         class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                         placeholder="Enter SSH password">
                </div>
                <div class="md:col-span-2">
                  <label for="sshPort" class="block text-sm font-medium text-gray-300 mb-1">SSH Port</label>
                  <input type="number" id="sshPort" name="sshPort" value="22" required
                         class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                         placeholder="Default: 22">
                </div>
              </div>

              <!-- Node Certificate -->
              <div class="mt-6">
                <label for="nodeCertificate" class="block text-sm font-medium text-gray-300 mb-1">Node Certificate <span class="text-red-500">*</span></label>
                <textarea id="nodeCertificate" name="nodeCertificate" rows="5"
                          class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                          placeholder="-----BEGIN CERTIFICATE----- ... -----END CERTIFICATE-----"></textarea>
                <div class="mt-2 flex items-center justify-between">
                    <button type="button" id="saveCertificateBtn" onclick="saveCertificate()"
                            class="px-3 py-1.5 rounded-md text-xs font-medium text-white bg-sky-600 hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-colors neon-hover">
                      Save as Default
                    </button>
                    <span id="certificateMessage" class="text-xs text-green-400 ml-2"></span>
                </div>
              </div>

              <!-- Node Port and Xray Version -->
              <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div>
                  <label for="nodeXrayPort" class="block text-sm font-medium text-gray-300 mb-1">Node Xray Port</label>
                  <input type="number" id="nodeXrayPort" name="nodeXrayPort"
                         class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                         placeholder="e.g., 443 or Xray inbound port">
                </div>
                <div>
                   <label for="xrayVersionSelect" class="block text-sm font-medium text-gray-300 mb-1">Xray Version <span class="text-red-500">*</span></label>
                  <select id="xrayVersionSelect" name="xrayVersionSelect"
                          class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-colors">
                    <option value="">Loading versions...</option>
                    <!-- Options will be populated by JavaScript -->
                  </select>
                </div>
              </div>

              <!-- Proxy Toggle -->
              <div class="mt-6 mb-4 flex items-center">
                <label for="useProxy" class="flex items-center cursor-pointer">
                  <div class="relative">
                    <input type="checkbox" id="useProxy" name="useProxy" class="sr-only peer">
                    <div class="w-10 h-6 bg-gray-600 rounded-full shadow-inner peer-checked:bg-purple-600 transition-colors"></div>
                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform peer-checked:translate-x-full"></div>
                  </div>
                  <div class="ml-3 text-sm font-medium text-gray-300">Iran Node (Use Proxy)</div>
                </label>
              </div>

              <!-- Proxy Fields (hidden by default) -->
              <div id="proxyFieldsContainer" class="hidden mt-4 p-4 border border-gray-700 rounded-lg bg-gray-800/30">
                <h4 class="text-md font-semibold text-purple-400 mb-3">SOCKS5 Proxy Settings</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                  <div>
                    <label for="proxyIP" class="block text-sm font-medium text-gray-300 mb-1">Proxy IP Address</label>
                    <input type="text" id="proxyIP" name="proxyIP"
                           class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                           placeholder="e.g., 127.0.0.1">
                  </div>
                  <div>
                    <label for="proxyPort" class="block text-sm font-medium text-gray-300 mb-1">Proxy Port</label>
                    <input type="number" id="proxyPort" name="proxyPort"
                           class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                           placeholder="e.g., 1080">
                  </div>
                  <div>
                    <label for="proxyUser" class="block text-sm font-medium text-gray-300 mb-1">Proxy Username <span class="text-xs text-gray-500">(Optional)</span></label>
                    <input type="text" id="proxyUser" name="proxyUser"
                           class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                           placeholder="Proxy username">
                  </div>
                  <div>
                    <label for="proxyPassword" class="block text-sm font-medium text-gray-300 mb-1">Proxy Password <span class="text-xs text-gray-500">(Optional)</span></label>
                    <input type="password" id="proxyPassword" name="proxyPassword"
                           class="w-full p-2.5 bg-gray-800/60 text-gray-100 rounded-lg border border-gray-700 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 placeholder-gray-500 transition-colors"
                           placeholder="Proxy password">
                  </div>
                  <div class="md:col-span-2 flex items-center space-x-2 mt-2">
                    <button type="button" id="testConnectionBtn" onclick="testSshAndProxyConnection()"
                            class="px-4 py-2 rounded-lg text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors neon-hover">
                      Test Connection
                    </button>
                    <span id="proxyTestResult" class="text-sm text-gray-400"></span>
                  </div>
                </div>
              </div>

              <div class="flex justify-end space-x-4 mt-8">
                <button type="button" onclick="closeAddNodeModal()"
                        class="px-6 py-2.5 rounded-lg text-sm font-medium text-gray-300 bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 transition-colors neon-hover">
                  Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2.5 rounded-lg text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition-colors neon-hover">
                  Save Node
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Progress Modal -->
        <div id="progressModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
          <div class="glass-effect rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-cyan-400 mb-4">Updating Core</h3>
            <p class="text-gray-200 mb-4">Please wait and do not refresh the page until the task is finished.</p>
            <div class="w-full bg-gray-700 rounded-full h-4 mb-4 relative">
              <div id="progressBar" class="bg-purple-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
              <span id="progressPercentage" class="absolute inset-0 flex items-center justify-center text-xs text-white font-semibold">0%</span>
            </div>
            <p id="progressMessage" class="text-gray-200 text-sm"></p>
          </div>
        </div>
      </main>

      <!-- JavaScript -->
      <script>
        const supportToggle = document.getElementById('supportToggle');
        const supportDropdown = document.getElementById('supportDropdown');
        supportToggle.addEventListener('click', () => {
          supportDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
          if (!supportToggle.contains(e.target) && !supportDropdown.contains(e.target)) {
            supportDropdown.classList.add('hidden');
          }
        });

        let currentNodeId = null;
        let selectedVersion = null;
        let versionListContent = null;
        let restartNodeId = null;
        let restartAction = null;

        function openChangeCoreModal(nodeId) {
          currentNodeId = nodeId;
          const button = document.getElementById(`changeCoreBtn-${nodeId}`);
          button.textContent = 'Loading...';
          button.disabled = true;

          fetch('/get_xray_versions')
            .then(response => response.json())
            .then(data => {
              button.textContent = 'Change Xray Core';
              button.disabled = false;

              if (data.error) {
                alert(data.error);
                return;
              }
              const versionList = document.getElementById('versionList');
              versionList.innerHTML = '';
              data.versions.forEach((version, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-2 hover:bg-gray-700/70 rounded cursor-pointer';
                div.innerHTML = `
                  <input type="radio" name="version" value="${version}" id="version${index}" class="mr-2">
                  <label for="version${index}" class="text-gray-200">${version}</label>
                `;
                div.onclick = () => {
                  document.getElementById(`version${index}`).checked = true;
                  selectedVersion = version;
                  document.getElementById('selectVersionBtn').disabled = false;
                };
                versionList.appendChild(div);
              });
              versionListContent = versionList.innerHTML;
              document.getElementById('customVersionBtn').classList.remove('hidden');
              document.getElementById('changeCoreModal').classList.remove('hidden');
            })
            .catch(err => {
              button.textContent = 'Change Xray Core';
              button.disabled = false;
              alert('Failed to fetch versions: ' + err);
            });
        }

        function closeChangeCoreModal(resetSelection = true) {
          document.getElementById('changeCoreModal').classList.add('hidden');
          document.getElementById('versionList').classList.remove('hidden');
          document.getElementById('customVersionInput').classList.add('hidden');
          document.getElementById('customVersionBtn').classList.remove('hidden');
          document.getElementById('backToListBtn').classList.add('hidden');
          if (resetSelection) {
            selectedVersion = null;
            document.getElementById('selectVersionBtn').disabled = true;
            document.getElementById('customVersionField').value = '';
          }
        }

        async function populateXrayVersionsDropdown() {
          xrayVersionSelect.innerHTML = '<option value=\"\">Loading versions...</option>';
          xrayVersionSelect.disabled = true;
          try {
            const response = await fetch('/get_xray_versions');
            if (!response.ok) {
              throw new Error(`HTTP error ${response.status}`);
            }
            const data = await response.json();
            if (data.error) {
              throw new Error(data.error);
            }
            xrayVersionSelect.innerHTML = '<option value=\"\">Select Xray Version (Optional)</option>';
            if (data.versions && data.versions.length > 0) {
              xrayVersionSelect.innerHTML = ''; // Clear previous options including "Loading..."
              data.versions.forEach((version, index) => {
                const option = document.createElement('option');
                option.value = version;
                option.textContent = index === 0 ? `${version} (latest)` : version;
                xrayVersionSelect.appendChild(option);
              });
              if (data.versions.length > 0) {
                xrayVersionSelect.value = data.versions[0]; // Select the first (latest) version
              }
            } else {
              xrayVersionSelect.innerHTML = '<option value=\"\">No versions found</option>';
            }
          } catch (error) {
            console.error('Failed to load Xray versions:', error);
            xrayVersionSelect.innerHTML = `<option value=\"\">Error loading versions</option>`;
          } finally {
            xrayVersionSelect.disabled = false;
          }
        }

        function showCustomVersionInput() {
          document.getElementById('versionList').classList.add('hidden');
          document.getElementById('customVersionInput').classList.remove('hidden');
          document.getElementById('customVersionBtn').classList.add('hidden');
          document.getElementById('backToListBtn').classList.remove('hidden');
          document.getElementById('selectVersionBtn').disabled = !document.getElementById('customVersionField').value;
        }

        function backToVersionList() {
          document.getElementById('versionList').innerHTML = versionListContent;
          document.getElementById('versionList').classList.remove('hidden');
          document.getElementById('customVersionInput').classList.add('hidden');
          document.getElementById('customVersionBtn').classList.remove('hidden');
          document.getElementById('backToListBtn').classList.add('hidden');
          selectedVersion = null;
          document.getElementById('selectVersionBtn').disabled = true;
        }

        function showConfirmModal() {
          if (!selectedVersion) {
            const customVersion = document.getElementById('customVersionField').value.trim();
            if (customVersion) {
              selectedVersion = customVersion;
            } else {
              alert('Please select a version or enter a custom version!');
              return;
            }
          }
          document.getElementById('selectedVersion').textContent = selectedVersion;
          document.getElementById('confirmModal').classList.remove('hidden');
          closeChangeCoreModal(false);
        }

        function closeConfirmModal() {
          document.getElementById('confirmModal').classList.add('hidden');
        }

        function showRestartConfirm(nodeId) {
          restartNodeId = nodeId;
          restartAction = 'single';
          document.getElementById('restartConfirmTitle').textContent = 'Confirm Xray Restart';
          document.getElementById('restartConfirmMessage').textContent = `Are you sure you want to restart Xray on node ${nodeId}?`;
          document.getElementById('restartConfirmModal').classList.remove('hidden');
          document.getElementById('confirmRestartBtn').onclick = () => restartCore(nodeId, 'xray');
        }

        function showRestartAllConfirm() {
          restartNodeId = null;
          restartAction = 'all';
          document.getElementById('restartConfirmTitle').textContent = 'Confirm All Xray Restarts';
          document.getElementById('restartConfirmMessage').textContent = 'Are you sure you want to restart Xray cores across all nodes? This may disrupt Xray services.';
          document.getElementById('restartConfirmModal').classList.remove('hidden');
          document.getElementById('confirmRestartBtn').onclick = restartAllXrayCores;
        }

        function closeRestartConfirm() {
          document.getElementById('restartConfirmModal').classList.add('hidden');
          restartNodeId = null;
          restartAction = null;
        }

        function startCoreChange() {
          if (!selectedVersion) {
            alert('No version selected! Please choose a version.');
            return;
          }
          document.getElementById('confirmModal').classList.add('hidden');
          document.getElementById('progressModal').classList.remove('hidden');
          document.getElementById('progressBar').style.width = '0%';
          document.getElementById('progressPercentage').textContent = '0%';
          document.getElementById('progressMessage').textContent = 'Initializing...';

          fetch(`/change_core/${currentNodeId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ version: selectedVersion })
          })
            .then(response => {
              if (!response.ok) {
                return response.text().then(text => { throw new Error(`Server error: ${text}`); });
              }
              const reader = response.body.getReader();
              const decoder = new TextDecoder();

              function readStream() {
                reader.read().then(({ done, value }) => {
                  if (done) {
                    console.log('Stream completed');
                    return;
                  }
                  const chunk = decoder.decode(value, { stream: true });
                  chunk.split('\n\n').forEach(event => {
                    if (event.startsWith('data: ')) {
                      try {
                        const data = JSON.parse(event.slice(6));
                        const bar = document.getElementById('progressBar');
                        const percentage = document.getElementById('progressPercentage');
                        const message = document.getElementById('progressMessage');

                        if ('progress' in data) {
                          bar.style.width = `${data.progress}%`;
                          percentage.textContent = `${data.progress}%`;
                        }
                        message.textContent = data.message;

                        if (data.done || data.status === 'success') {
                          setTimeout(() => {
                            document.getElementById('progressModal').classList.add('hidden');
                            const duration = data.duration || data.message.split(' ').pop();
                            showNotification(`Core updated successfully in ${duration} seconds.`);
                            setTimeout(() => location.reload(), 2000);
                          }, 1000);
                        } else if (data.error || data.message === 'Download failed.') {
                          setTimeout(() => {
                            document.getElementById('progressModal').classList.add('hidden');
                            alert(`Error: ${data.message}`);
                          }, 1000);
                        }
                      } catch (e) {
                        console.error('JSON parse error:', e);
                      }
                    }
                  });
                  readStream();
                }).catch(err => {
                  document.getElementById('progressModal').classList.add('hidden');
                  alert('Stream error: ' + err.message);
                });
              }
              readStream();
            })
            .catch(err => {
              document.getElementById('progressModal').classList.add('hidden');
              alert('Fetch error: ' + err.message);
            });
        }

        // Restart Functions
        function restartCore(nodeId, coreName) {
          if (coreName !== 'xray') return; // Only allow Xray restarts
          closeRestartConfirm();
          fetch(`/node/${nodeId}/restart_cores`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cores: ['xray'] })
          })
            .then(response => response.json())
            .then(data => {
              if (data['xray'] && data['xray'].status === 'success') {
                showNotification(`Successfully restarted Xray on node ${nodeId}`);
                setTimeout(() => location.reload(), 2000);
              } else {
                alert(`Failed to restart Xray: ${data['xray'].message}`);
              }
            })
            .catch(err => alert('Error restarting Xray: ' + err.message));
        }

        function restartAllXrayCores() {
          closeRestartConfirm();
          document.getElementById('restartAllNodesCoresBtn').disabled = true;
          document.getElementById('restartAllNodesCoresBtn').textContent = 'Restarting...';
          fetch('/restart_all_nodes_cores', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          })
            .then(response => response.json())
            .then(data => {
              document.getElementById('restartAllNodesCoresBtn').disabled = false;
              document.getElementById('restartAllNodesCoresBtn').textContent = 'Restart All Xray Cores';
              let allSuccess = true;
              let messages = [];
              for (const nodeId in data) {
                let nodeMessage = `Node ${nodeId}: `;
                if (data[nodeId]['xray']) {
                  if (data[nodeId]['xray'].status === 'success') {
                    nodeMessage += `Xray OK`;
                  } else {
                    allSuccess = false;
                    nodeMessage += `Xray (${data[nodeId]['xray'].message})`;
                  }
                } else {
                  nodeMessage += 'Xray not present';
                }
                messages.push(nodeMessage);
              }
              if (allSuccess) {
                showNotification('All Xray cores across all nodes restarted successfully');
                setTimeout(() => location.reload(), 2000);
              } else {
                alert(`Restart results:\n${messages.join('\n')}`);
              }
            })
            .catch(err => {
              document.getElementById('restartAllNodesCoresBtn').disabled = false;
              document.getElementById('restartAllNodesCoresBtn').textContent = 'Restart All Xray Cores';
              alert('Error restarting all Xray cores: ' + err.message);
            });
        }

        function showNotification(message) {
          const notification = document.createElement('div');
          notification.className = 'notification';
          notification.textContent = message;
          document.body.appendChild(notification);
          setTimeout(() => notification.remove(), 5000);
        }

        document.getElementById('selectVersionBtn').addEventListener('click', showConfirmModal);
        document.getElementById('customVersionBtn').addEventListener('click', showCustomVersionInput);
        document.getElementById('backToListBtn').addEventListener('click', backToVersionList);
        document.getElementById('customVersionField').addEventListener('input', (e) => {
          document.getElementById('selectVersionBtn').disabled = !e.target.value.trim();
        });

        // Add Node Modal Functions
        const addNodeModal = document.getElementById('addNodeModal');
        const addNodeForm = document.getElementById('addNodeForm');
        const addNodeModalContent = addNodeModal.querySelector('.glass-effect');
        const useProxyCheckbox = document.getElementById('useProxy');
        const proxyFieldsContainer = document.getElementById('proxyFieldsContainer');
        const proxyTestResultSpan = document.getElementById('proxyTestResult');
        const nodeCertificateTextarea = document.getElementById('nodeCertificate');
        const certificateMessageSpan = document.getElementById('certificateMessage');
        const nodeXrayPortInput = document.getElementById('nodeXrayPort');
        const xrayVersionSelect = document.getElementById('xrayVersionSelect');

        function toggleProxyFields() {
          if (useProxyCheckbox.checked) {
            proxyFieldsContainer.classList.remove('hidden');
          } else {
            proxyFieldsContainer.classList.add('hidden');
          }
        }

        useProxyCheckbox.addEventListener('change', toggleProxyFields);

        function saveCertificate() {
          const certificateValue = nodeCertificateTextarea.value;
          localStorage.setItem('defaultNodeCertificate', certificateValue);
          certificateMessageSpan.textContent = 'Default certificate saved!';
          certificateMessageSpan.className = 'text-xs text-green-400 ml-2';
          setTimeout(() => {
            certificateMessageSpan.textContent = '';
          }, 3000);
        }

        function openAddNodeModal() {
          addNodeForm.reset();
          proxyTestResultSpan.textContent = '';
          certificateMessageSpan.textContent = '';
          nodeXrayPortInput.value = '';

          // Load default certificate
          const defaultCertificate = localStorage.getItem('defaultNodeCertificate');
          nodeCertificateTextarea.value = defaultCertificate || '';

          // Set proxy toggle to off by default, then load saved proxy fields
          useProxyCheckbox.checked = false;
          toggleProxyFields(); // Ensure proxy fields are hidden initially based on the toggle being off

          document.getElementById('proxyIP').value = localStorage.getItem('defaultProxyIP') || '';
          document.getElementById('proxyPort').value = localStorage.getItem('defaultProxyPort') || '';
          document.getElementById('proxyUser').value = localStorage.getItem('defaultProxyUser') || '';
          document.getElementById('proxyPassword').value = localStorage.getItem('defaultProxyPassword') || '';

          populateXrayVersionsDropdown();

          addNodeModal.classList.remove('hidden');
          setTimeout(() => {
            addNodeModalContent.classList.remove('opacity-0', 'translate-y-10');
            addNodeModalContent.classList.add('opacity-100', 'translate-y-0');
          }, 10);
        }

        function closeAddNodeModal() {
          addNodeModalContent.classList.remove('opacity-100', 'translate-y-0');
          addNodeModalContent.classList.add('opacity-0', 'translate-y-10');
          setTimeout(() => {
            addNodeModal.classList.add('hidden');
            // addNodeForm.reset(); // Already reset in openAddNodeModal or after submit
          }, 300);
        }

        addNodeForm.addEventListener('submit', function(event) {
          event.preventDefault();
          saveNode();
        });

        async function saveNode() {
          const formData = new FormData(addNodeForm);
          const data = Object.fromEntries(formData.entries());
          data.useProxy = useProxyCheckbox.checked;
          data.nodeXrayPort = nodeXrayPortInput.value;
          data.selectedXrayVersion = xrayVersionSelect.value;

          // Encode certificate to Base64
          try {
            data.nodeCertificate = btoa(nodeCertificateTextarea.value.trim());
          } catch (e) {
            showNotification('Error encoding certificate. Please ensure it is valid text.');
            console.error("Certificate encoding error:", e);
            return;
          }

          const requiredFields = {
            "Node Name": data.nodeName,
            "Server IP": data.serverIP,
            "SSH Username": data.sshUser,
            "SSH Password": data.sshPassword,
            "SSH Port": data.sshPort,
            "Node Certificate": data.nodeCertificate,
            "Xray Version": data.selectedXrayVersion
          };

          for (const [fieldName, value] of Object.entries(requiredFields)) {
            if (!value) {
              showNotification(`Please fill in the '${fieldName}' field.`);
              return;
            }
          }

          // Specific check for Xray Version if it has a placeholder value like ""
          if (xrayVersionSelect.value === "") {
              showNotification('Please select a valid Xray Version.');
              return;
          }

          if (data.useProxy && (!data.proxyIP || !data.proxyPort)) {
            showNotification('Proxy IP and Port are required when proxy is enabled.');
            return;
          }

          const submitButton = addNodeForm.querySelector('button[type="submit"]');
          const originalButtonText = submitButton.textContent;
          submitButton.disabled = true;
          submitButton.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Fetching hostname... Please wait.
          `;
          // Clear previous results from test connection span
          proxyTestResultSpan.textContent = '';
          proxyTestResultSpan.className = 'text-sm text-gray-400';


          try {
            const response = await fetch('/add_node_ssh', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (result.success) {
              let resultMessage = `<strong>Hostname for '${data.nodeName}' retrieved successfully!</strong><br>`;
              const serverIpFromResult = result.server_ip_result || data.serverIP;
              const hostnameFromResult = result.hostname || 'N/A';

              resultMessage += `Server IP: <code class="bg-gray-700 px-1 rounded break-all">${serverIpFromResult}</code><br>`;
              resultMessage += `Hostname: <code class="bg-gray-700 px-1 rounded break-all">${hostnameFromResult}</code>`;

              const finalMessage = `${resultMessage}<br><button type="button" onclick="copyHostnameDetails('${serverIpFromResult}', '${hostnameFromResult}')" class="mt-2 text-xs bg-blue-500 hover:bg-blue-600 text-white py-1 px-2 rounded shadow focus:outline-none focus:ring-2 focus:ring-blue-400">Copy Details</button>`;

              proxyTestResultSpan.innerHTML = finalMessage;
              proxyTestResultSpan.className = 'text-sm text-green-400 block mt-2 p-2 bg-gray-800/50 rounded';

              showNotification(`Hostname for '${data.nodeName}' retrieved. See details in modal.`);
            } else {
              showNotification(result.message || 'Failed to retrieve hostname.');
              proxyTestResultSpan.textContent = `Error: ${result.message || 'Unknown error.'}`;
              if (result.hostname !== undefined && result.hostname !== "") {
                proxyTestResultSpan.textContent += ` (Hostname: ${result.hostname})`;
              } else if (result.hostname === "") {
                 proxyTestResultSpan.textContent += ` (Hostname: Not available or empty)`;
              }
              proxyTestResultSpan.className = 'text-sm text-red-400 block mt-2 p-2 bg-red-900/30 rounded';
            }
          } catch (error) {
            console.error('Error retrieving hostname:', error);
            showNotification(`Error: ${error.message}`);
            proxyTestResultSpan.textContent = `Error: ${error.message}`;
            proxyTestResultSpan.className = 'text-sm text-red-400 block mt-2 p-2 bg-red-900/30 rounded';
          } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonText;
          }
        }

        function copyHostnameDetails(ip, hostname) {
          const textToCopy = `Server IP: ${ip}\nHostname: ${hostname}`;
          navigator.clipboard.writeText(textToCopy).then(() => {
            showNotification('Details copied to clipboard!');
          }).catch(err => {
            showNotification('Failed to copy details.');
            console.error('Could not copy text: ', err);
          });
        }

        async function testSshAndProxyConnection() {
          const serverIP = document.getElementById('serverIP').value;
          const sshPort = document.getElementById('sshPort').value;
          const sshUser = document.getElementById('sshUser').value;
          const sshPassword = document.getElementById('sshPassword').value;

          const useProxy = useProxyCheckbox.checked;
          const proxyIP = document.getElementById('proxyIP').value;
          const proxyPort = document.getElementById('proxyPort').value;
          const proxyUser = document.getElementById('proxyUser').value;
          const proxyPassword = document.getElementById('proxyPassword').value;

          if (!serverIP || !sshPort || !sshUser || !sshPassword) {
            proxyTestResultSpan.textContent = 'SSH IP, Port, User, and Password are required for testing.';
            proxyTestResultSpan.className = 'text-sm text-red-400';
            return;
          }
          if (useProxy && (!proxyIP || !proxyPort)) {
            proxyTestResultSpan.textContent = 'Proxy IP and Port are required when proxy is enabled for testing.';
            proxyTestResultSpan.className = 'text-sm text-red-400';
            return;
          }

          proxyTestResultSpan.textContent = 'Testing connection...';
          proxyTestResultSpan.className = 'text-sm text-yellow-400';
          const testButton = document.getElementById('testConnectionBtn'); // Corrected ID
          testButton.disabled = true;
          testButton.textContent = 'Testing...';

          const payload = {
            ssh_ip: serverIP, ssh_port: sshPort, ssh_user: sshUser, ssh_pass: sshPassword,
            use_proxy: useProxy,
            proxy_ip: proxyIP, proxy_port: proxyPort, proxy_user: proxyUser, proxy_pass: proxyPassword
          };

          try {
            const response = await fetch('/test_full_connection', { // Updated endpoint
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });

            const result = await response.json();
            let message = "";
            let overallSuccess = false;

            if (useProxy) {
              message += `Proxy: ${result.proxy_status === 'success' ? `OK (IP: ${result.proxy_seen_ip || 'N/A'})` : `Failed (${result.proxy_message || 'Error'})`} | `;
            }
            message += `SSH: ${result.ssh_status === 'success' ? 'OK' : `Failed (${result.ssh_message || 'Error'})`}`;

            if (result.ssh_status === 'success' && (result.proxy_status === 'success' || !useProxy)) {
              overallSuccess = true;
            }

            proxyTestResultSpan.textContent = message;
            proxyTestResultSpan.className = `text-sm ${overallSuccess ? 'text-green-400' : 'text-red-400'}`;

            if (overallSuccess && useProxy && result.proxy_status === 'success' && result.ssh_status === 'success') {
                localStorage.setItem('defaultProxyIP', document.getElementById('proxyIP').value);
                localStorage.setItem('defaultProxyPort', document.getElementById('proxyPort').value);
                localStorage.setItem('defaultProxyUser', document.getElementById('proxyUser').value);
                localStorage.setItem('defaultProxyPassword', document.getElementById('proxyPassword').value);
                // Do NOT save 'defaultUseProxy' here, so it always defaults to off when modal opens
                showNotification('SOCKS Proxy details saved as default for next use. (Toggle will be off by default next time)');
            }
            // No need for the else-if that sets defaultUseProxy to false, as it's always false on open.

          } catch (error) {
            console.error('Error testing connection:', error);
            proxyTestResultSpan.textContent = `Connection Test Error: ${error.message}`;
            proxyTestResultSpan.className = 'text-sm text-red-400';
          } finally {
            testButton.disabled = false;
            testButton.textContent = 'Test Connection';
          }
        }

        // Close modal if clicked outside of it
        addNodeModal.addEventListener('click', function(event) {
          if (event.target === addNodeModal) {
            closeAddNodeModal();
          }
        });

      </script>
    </body>
</html>
